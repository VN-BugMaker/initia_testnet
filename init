#!/bin/bash

# Logo

read -r -p "Enter node name: " NODE_MONIKER

CHAIN_ID="initiation-1"
CHAIN_DENOM="initiad"
BINARY_NAME="initiad"
GITHUB="https://github.com/VN-BugMaker"
BINARY_VERSION_TAG="v0.2.14"

echo -e "Node moniker: ${CYAN}$NODE_MONIKER${NC}"
echo -e "Chain id:     ${CYAN}$CHAIN_ID${NC}"
echo -e "Chain demon:  ${CYAN}$CHAIN_DENOM${NC}"
echo -e "Binary version tag:  ${CYAN}$BINARY_VERSION_TAG${NC}"

sleep 1

echo -e "\e[1m\e[32m1. Updating packages and dependencies--> \e[0m" && sleep 1
#UPDATE APT
sudo apt update && sudo apt upgrade -y
sudo apt install curl tar wget clang pkg-config libssl-dev libleveldb-dev jq build-essential bsdmainutils git make ncdu htop lz4 screen unzip bc fail2ban htop -y

echo -e "\e[1m\e[32m2. Installing GO--> \e[0m" && sleep 1
#INSTALL GO
sudo rm -rf /usr/local/go
curl -L https://go.dev/dl/go1.22.2.linux-amd64.tar.gz | sudo tar -xzf - -C /usr/local
echo 'export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin' >> $HOME/.bash_profile
source .bash_profile

echo -e "\e[1m\e[32m3. Downloading and building binaries--> \e[0m" && sleep 1

git clone https://github.com/initia-labs/initia.git
cd initia
git checkout v0.2.14
make install

initiad config set client chain-id $CHAIN_ID
initiad config set client keyring-backend test
initiad config set client node tcp://localhost:26657
initiad init "$NODE_MONIKER" --chain-id $CHAIN_ID

curl -L https://snapshot.validatorvn.com/initia/addrbook.json > $HOME/.initia/config/addrbook.json
wget -O $HOME/.initia/config/genesis.json https://testnet-files.itrocket.net/initia/genesis.json

sed -i -e "s|^seeds *=.*|seeds = \"3f472746f46493309650e5a033076689996c8881@initia-testnet.rpc.kjnodes.com:17959\"|" $HOME/.initia/config/config.toml
PEERS="3c070df6ec170b9a91964a551a18f47b932e248e@37.27.100.176:27656,b8a957a490470730bd804888abe442aaf38680c0@148.251.91.93:27656,3af9684a5654604dc954194d8434dafa3ee8ed83@194.242.57.14:27656,75c6e07fa311444373a707de5903802c6d161455@95.217.78.33:27656,53afead96dd874226140ed2d89733116ff7dca64@130.185.119.201:27656,5aaf3bd53ad1cc492410d1a8d210da21b7ea3cbb@158.220.104.150:26656,7da48696a3727059cb84c429e589080b140dec27@37.27.119.144:27656,20b69b885fd9aa4f845b2686793183a9035fbf34@38.242.219.222:27656,76179c27beaaea2a870a686816f34310d5d8ebd2@37.27.100.173:27656,e6abb670d1e8ca416ff4c41813f34e294f0de831@158.220.92.24:27656,2e947b2f41266cd2cf5ba0098cfec1bb92c26e2d@37.27.59.99:27656,d571b906c86697319cd937ca79b7218cdeaf1428@37.27.119.154:27656,cc4d4dd23ea0f35f46337361bfc0710a9a4ecd1d@38.242.214.181:27656,149e86cea8666d9629eddf629bcbd42d563e69f4@43.153.68.225:26656,d0e59cf5607ed3241e193995f344c80c536a3b9f@37.27.119.209:27656,4b0e9a61e9f132dbb266d9a17bbc3c77f67201a8@65.21.233.188:40056,151ea1a88cbeb4d14056c2122e9d6bb30bd3fb6a@193.187.129.109:27656,b1dc286c333a3e853008ac361ec40f253ae44bb2@38.242.157.180:27656,25d66b814d5fe016f082374c523a81f9dab579fe@37.27.119.149:27656,2851ae0487ce78f2006f3cba0823cc48b812f14c@47.238.235.148:27656"
sed -i 's|^persistent_peers *=.*|persistent_peers = "'$PEERS'"|' $HOME/.initia/config/config.toml

sed -i \
  -e 's|^pruning *=.*|pruning = "custom"|' \
  -e 's|^pruning-keep-recent *=.*|pruning-keep-recent = "100"|' \
  -e 's|^pruning-keep-every *=.*|pruning-keep-every = "0"|' \
  -e 's|^pruning-interval *=.*|pruning-interval = "19"|' \
  $HOME/.initia/config/app.toml

# set minimum gas price, enable prometheus and disable indexing
sed -i 's|minimum-gas-prices =.*|minimum-gas-prices = "0.15uinit,0.01uusdc"|g' $HOME/.initia/config/app.toml
sed -i -e "s/prometheus = false/prometheus = true/" $HOME/.initia/config/config.toml
sed -i -e "s/^indexer *=.*/indexer = \"null\"/" $HOME/.initia/config/config.toml
sed -i 's|^prometheus *=.*|prometheus = true|' $HOME/.initia/config/config.toml

echo -e "\e[1m\e[32m4. Starting service and synchronization...--> \e[0m" && sleep 1

sudo tee /etc/systemd/system/initiad.service > /dev/null <<EOF
[Unit]
Description=Initia node
After=network-online.target
[Service]
User=$USER
WorkingDirectory=$HOME/.initia
ExecStart=$(which initiad) start --home $HOME/.initia
Restart=on-failure
RestartSec=5
LimitNOFILE=65535
[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable initiad.service

cp $HOME/.initia/data/priv_validator_state.json $HOME/.initia/priv_validator_state.json.backup
initiad tendermint unsafe-reset-all --home $HOME/.initia --keep-addr-book

curl -O https://snapshots-testnet.nodejumper.io/initia-testnet/initia-testnet_latest.tar.lz4
lz4 -d -c ./initia-testnet_latest.tar.lz4 | tar -xf - -C $HOME/.initia

mv $HOME/.initia/priv_validator_state.json.backup $HOME/.initia/data/priv_validator_state.json
sudo systemctl start initiad

echo '=============== SETUP FINISHED ==================='
echo -e "Check logs:            ${CYAN}sudo journalctl -u $BINARY_NAME -f --no-hostname -o cat ${NC}"
echo -e "Check synchronization: ${CYAN}$BINARY_NAME status 2>&1 | jq .SyncInfo.catching_up${NC}"
echo -e "More commands:         ${CYAN}$GITHUB${NC}"
